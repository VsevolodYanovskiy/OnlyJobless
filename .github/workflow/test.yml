name: CI Tests

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]

jobs:
  test:
    name: Run Tests & Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      id: checkout
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python 3.12.5
      id: setup_python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12.5'
        cache: 'pip'
    
    - name: ğŸ“¦ Install dependencies
      id: install_deps
      run: |
        python -m pip install --upgrade pip
        pip install bcrypt pytest pytest-cov flake8 mypy
        
        if [ -f docs/requirements.txt ]; then
          pip install -r docs/requirements.txt 2>/dev/null || true
        fi
    
    - name: ğŸ” Check project structure
      id: check_structure
      run: |
        echo "=== Project structure ==="
        find . -name "*.py" | head -5
        echo "Tests dir exists:" && [ -d "tests" ] && echo "YES" || echo "NO"
        echo "Src dir exists:" && [ -d "src" ] && echo "YES" || echo "NO"
    
    - name: ğŸ§¹ Run flake8 (src only)
      id: flake8_lint
      continue-on-error: true
      run: |
        echo "=== Flake8 checking src/ only ==="
        if [ -d "src" ]; then
          flake8 src/ --count --max-line-length=120 --statistics || echo "Flake8 completed with warnings"
        else
          echo "No src directory - skipping flake8"
        fi
    
    - name: ğŸ“ Run mypy (src only)
      id: mypy_check
      continue-on-error: true
      run: |
        echo "=== Mypy checking src/ only ==="
        if [ -d "src" ]; then
          python -m mypy src/ --ignore-missing-imports --show-error-codes --disable-error-code=import-untyped || echo "Mypy completed with warnings"
        else
          echo "No src directory - skipping mypy"
        fi
    
    - name: ğŸ§ª Run tests if they exist
      id: run_tests
      run: |
        echo "=== Test Execution ==="
        
        if [ ! -d "tests" ]; then
          echo "âœ… No tests directory - SUCCESS"
          exit 0
        fi
        
        TEST_COUNT=$(find tests -name "test_*.py" -type f | wc -l)
        echo "Found $TEST_COUNT test file(s)"
        
        if [ $TEST_COUNT -gt 0 ]; then
          echo "Running tests..."
          
          if [ -d "src" ]; then
            python -m pytest tests/ -v --tb=short --cov=src --cov-report=term-missing --junitxml=test-results.xml
            TEST_EXIT_CODE=$?
          else
            python -m pytest tests/ -v --tb=short --junitxml=test-results.xml
            TEST_EXIT_CODE=$?
          fi
          
          if [ $TEST_EXIT_CODE -eq 0 ]; then
            echo "âœ… All tests passed"
          else
            echo "âŒ Some tests failed"
            exit $TEST_EXIT_CODE
          fi
        else
          echo "âœ… No test files found - SUCCESS"
        fi
    
    - name: ğŸ“Š Upload test results
      if: always() && steps.run_tests.outcome == 'success' || steps.run_tests.outcome == 'failure'
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: test-results.xml
    
    - name: âœ… Final status with accurate reporting
      if: always()
      run: |
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘                    CI PIPELINE REPORT                        â•‘"
        echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
        echo "â•‘ Python Version: 3.12.5                                       â•‘"
        echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
        
        # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ¸ĞºĞ¾Ğ½ĞºĞ¸ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ²
        FLAKE8_ICON="â“"
        MYPY_ICON="â“"
        TESTS_ICON="â“"
        
        # Flake8 ÑÑ‚Ğ°Ñ‚ÑƒÑ
        if [ "${{ steps.flake8_lint.outcome }}" == "success" ]; then
          FLAKE8_ICON="âœ…"
          FLAKE8_STATUS="PASSED"
        elif [ "${{ steps.flake8_lint.outcome }}" == "failure" ]; then
          FLAKE8_ICON="âŒ"
          FLAKE8_STATUS="FAILED"
        elif [ "${{ steps.flake8_lint.outcome }}" == "skipped" ]; then
          FLAKE8_ICON="â­ï¸"
          FLAKE8_STATUS="SKIPPED"
        else
          FLAKE8_ICON="âš ï¸"
          FLAKE8_STATUS="${{ steps.flake8_lint.outcome }}"
        fi
        
        # Mypy ÑÑ‚Ğ°Ñ‚ÑƒÑ
        if [ "${{ steps.mypy_check.outcome }}" == "success" ]; then
          MYPY_ICON="âœ…"
          MYPY_STATUS="PASSED"
        elif [ "${{ steps.mypy_check.outcome }}" == "failure" ]; then
          MYPY_ICON="âŒ"
          MYPY_STATUS="FAILED"
        elif [ "${{ steps.mypy_check.outcome }}" == "skipped" ]; then
          MYPY_ICON="â­ï¸"
          MYPY_STATUS="SKIPPED"
        else
          MYPY_ICON="âš ï¸"
          MYPY_STATUS="${{ steps.mypy_check.outcome }}"
        fi
        
        # Tests ÑÑ‚Ğ°Ñ‚ÑƒÑ
        if [ "${{ steps.run_tests.outcome }}" == "success" ]; then
          TESTS_ICON="âœ…"
          TESTS_STATUS="PASSED"
        elif [ "${{ steps.run_tests.outcome }}" == "failure" ]; then
          TESTS_ICON="âŒ"
          TESTS_STATUS="FAILED"
        elif [ "${{ steps.run_tests.outcome }}" == "skipped" ]; then
          TESTS_ICON="â­ï¸"
          TESTS_STATUS="SKIPPED"
        else
          TESTS_ICON="âš ï¸"
          TESTS_STATUS="${{ steps.run_tests.outcome }}"
        fi
        
        # Ğ’Ñ‹Ğ²Ğ¾Ğ´Ğ¸Ğ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹
        echo "â•‘ Flake8 Linting:   $FLAKE8_ICON $FLAKE8_STATUS"
        echo "â•‘ Mypy Type Check:  $MYPY_ICON $MYPY_STATUS"
        echo "â•‘ Tests Execution:  $TESTS_ICON $TESTS_STATUS"
        echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
        
        # ĞĞ±Ñ‰Ğ¸Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ
        if [ "${{ job.status }}" == "success" ]; then
          echo "â•‘                    âœ¨ ALL CHECKS PASSED âœ¨                    â•‘"
          echo "â•‘                      Pipeline: SUCCESS                      â•‘"
        elif [ "${{ job.status }}" == "failure" ]; then
          echo "â•‘                   ğŸ’¥ SOME CHECKS FAILED ğŸ’¥                   â•‘"
          echo "â•‘                      Pipeline: FAILURE                      â•‘"
        elif [ "${{ job.status }}" == "cancelled" ]; then
          echo "â•‘                    ğŸ›‘ PIPELINE CANCELLED ğŸ›‘                   â•‘"
        else
          echo "âœ… No test files found - SUCCESS"
        fi
