name: CI Tests

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]name: CI Tests

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]

jobs:
  test:
    name: Run Tests & Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: üêç Setup Python 3.12.5
      uses: actions/setup-python@v4
      with:
        python-version: '3.12.5'
        cache: 'pip'
    
    - name: üì¶ Install dependencies
      run: |
        python -m pip install --upgrade pip
        # –û—Å–Ω–æ–≤–Ω—ã–µ –¥–ª—è —Ç–µ—Å—Ç–æ–≤
        pip install bcrypt pytest pytest-cov
        
        # –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞
        pip install flake8 mypy
        
        # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ - requirements.txt
        if [ -f docs/requirements.txt ]; then
          pip install -r docs/requirements.txt 2>/dev/null || true
        fi
    
    - name: üîç Check project structure
      run: |
        echo "=== Project structure ==="
        find . -name "*.py" | head -20
        echo "=== Tests ==="
        ls -la tests/ 2>/dev/null || echo "No tests directory"
        echo "=== src ==="
        ls -la src/ 2>/dev/null || echo "No src directory"
    
    - name: üßπ Run flake8 linting
      run: |
        echo "=== Running flake8 ==="
        if [ -d "src" ]; then
          flake8 src/ --count --max-line-length=120 --statistics --show-source
        else
          echo "No src directory to lint"
        fi
        
        if [ -d "tests" ]; then
          flake8 tests/ --count --max-line-length=120 --statistics --show-source
        else
          echo "No tests directory to lint"
        fi
    
    - name: üìù Run mypy type checking
      run: |
        echo "=== Running mypy ==="
        if [ -d "src" ]; then
          mypy src/ --ignore-missing-imports --show-error-codes
        else
          echo "No src directory for type checking"
        fi
        
        if [ -d "tests" ]; then
          mypy tests/ --ignore-missing-imports --show-error-codes
        else
          echo "No tests directory for type checking"
        fi
    
    - name: üß™ Run tests if they exist
      run: |
        # –ï—Å–ª–∏ –Ω–µ—Ç —Ç–µ—Å—Ç–æ–≤ - —É—Å–ø–µ—Ö
        if [ ! -d "tests" ]; then
          echo "‚úÖ No tests directory - SUCCESS"
          exit 0
        fi
        
        # –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–∞–π–ª—ã test_*.py - –∑–∞–ø—É—Å–∫–∞–µ–º
        if find tests -name "test_*.py" -type f | grep -q .; then
          echo "=== Running pytest ==="
          python -m pytest tests/ -v --tb=short --cov=src --cov-report=term-missing
        else
          echo "‚úÖ No test files found - SUCCESS"
        fi
    
    - name: üìä Generate coverage report
      if: always()
      run: |
        echo "=== Coverage Summary ==="
        if [ -d "tests" ] && [ -d "src" ]; then
          python -m pytest tests/ --cov=src --cov-report=xml --quiet 2>/dev/null || true
          if [ -f "coverage.xml" ]; then
            echo "Coverage report generated"
          fi
        fi
    
        - name: ‚úÖ Final status
      if: always()
      run: |
        echo "========================================"
        echo "üéØ CI Pipeline Summary"
        echo "Python: 3.12.5"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —à–∞–≥–æ–≤
        echo "=== Step Results ==="
        
        # Flake8 —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        if [ "${{ steps.flake8_lint.outcome }}" == "success" ]; then
          echo "Flake8: ‚úÖ PASSED"
        elif [ "${{ steps.flake8_lint.outcome }}" == "failure" ]; then
          echo "Flake8: ‚ùå FAILED"
        elif [ "${{ steps.flake8_lint.outcome }}" == "skipped" ]; then
          echo "Flake8: ‚è≠Ô∏è SKIPPED"
        else
          echo "Flake8: ‚ö†Ô∏è ${{ steps.flake8_lint.outcome }}"
        fi
        
        # Mypy —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        if [ "${{ steps.mypy_check.outcome }}" == "success" ]; then
          echo "Mypy: ‚úÖ PASSED"
        elif [ "${{ steps.mypy_check.outcome }}" == "failure" ]; then
          echo "Mypy: ‚ùå FAILED"
        elif [ "${{ steps.mypy_check.outcome }}" == "skipped" ]; then
          echo "Mypy: ‚è≠Ô∏è SKIPPED"
        else
          echo "Mypy: ‚ö†Ô∏è ${{ steps.mypy_check.outcome }}"
        fi
        
        # Pytest —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        if [ "${{ steps.run_tests.outcome }}" == "success" ]; then
          echo "Tests: ‚úÖ PASSED"
        elif [ "${{ steps.run_tests.outcome }}" == "failure" ]; then
          echo "Tests: ‚ùå FAILED"
        elif [ "${{ steps.run_tests.outcome }}" == "skipped" ]; then
          echo "Tests: ‚è≠Ô∏è SKIPPED"
        else
          echo "Tests: ‚ö†Ô∏è ${{ steps.run_tests.outcome }}"
        fi
        
        echo "========================================"
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â–∏–π —Å—Ç–∞—Ç—É—Å
        if [ "${{ job.status }}" == "success" ]; then
          echo "‚ú® ALL CHECKS PASSED ‚ú®"
        elif [ "${{ job.status }}" == "failure" ]; then
          echo "üí• SOME CHECKS FAILED üí•"
        else
          echo "‚ö†Ô∏è PIPELINE ${{ job.status }}"
        fi
