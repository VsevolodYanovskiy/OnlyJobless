name: CI Tests

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]

jobs:
  test:
    name: Run Tests & Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout code
      id: checkout
      uses: actions/checkout@v4
    
    - name: 🐍 Setup Python 3.12.5
      id: setup_python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12.5'
        cache: 'pip'
    
    - name: 📦 Install dependencies
      id: install_deps
      run: |
        python -m pip install --upgrade pip

        if [ -f "project send/requirements.txt" ]; then
          echo "Installing dependencies from requirements.txt..."
          pip install -r "project send/requirements.txt"
        else
          echo "ERROR: requirements.txt not found!"
          pip install bcrypt pytest pytest-cov flake8 mypy
          exit 1
        fi

    - name: 🧪 Run tests
      id: run_tests
      env:
        ENCRYPTION_KEY: "dGVzdF9rZXlfMzJfY2hhcnNfZm9yX2Flc18yNTY="
        SECRET_KEY: "test_secret_key_for_ci_1234567890"
        DATABASE_URL: "sqlite:///./test.db"
        ENVIRONMENT: "test"
        JWT_ALGORITHM: "HS256"
        JWT_ACCESS_TOKEN_EXPIRE_MINUTES: "30"
      run: |
        echo "=== Test Execution ==="
        TEST_PATH="project send/backend/tests"
        BACKEND_PATH="project send/backend"
        echo "Checking for tests in: $TEST_PATH"
        if [ ! -d "$TEST_PATH" ]; then
          echo "✅ No tests directory found at '$TEST_PATH' - SUCCESS"
          exit 0
        fi
        TEST_COUNT=$(find "$TEST_PATH" -name "test_*.py" -type f | wc -l)
        echo "Found $TEST_COUNT test file(s) in $TEST_PATH"
        if [ $TEST_COUNT -gt 0 ]; then
          echo "Running tests from $TEST_PATH..."
          cd "project send/backend"
          
          python -m pytest tests/ -v --tb=short --junitxml=../test-results.xml
          TEST_EXIT_CODE=$?
          cd ../..
          if [ $TEST_EXIT_CODE -eq 0 ]; then
            echo "✅ All tests passed"
          else
            echo "❌ Some tests failed"
            exit $TEST_EXIT_CODE
          fi
        else
          echo "✅ No test files found - SUCCESS"
        fi
    
    - name: 📊 Upload test results
      if: always() && steps.run_tests.outcome == 'success' || steps.run_tests.outcome == 'failure'
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: project send/test-results.xml
    
    - name: 📋 Generate CI Report
      if: always()
      id: generate_report
      run: |
        format_status() {
          case "$1" in
            "success")
              echo "✅ PASSED"
              ;;
            "failure")
              echo "❌ FAILED"
              ;;
            "skipped")
              echo "⏭️ SKIPPED"
              ;;
            "cancelled")
              echo "🛑 CANCELLED"
              ;;
            *)
              echo "⚠️ $1"
              ;;
          esac
        }
        
        TESTS_STATUS=$(format_status "${{ steps.run_tests.outcome }}")

        echo "## 📊 CI Pipeline Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Python Version:** 3.12.5" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📈 Quality Checks" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status | Details |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|---------|" >> $GITHUB_STEP_SUMMARY
        echo "| **Tests Execution** | $TESTS_STATUS | Unit and integration tests |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 🎯 Final Result" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ job.status }}" == "success" ]; then
          echo "### ✨ ALL CHECKS PASSED ✨" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pipeline Status:** ✅ **SUCCESS**" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ job.status }}" == "failure" ]; then
          echo "### 💥 CHECKS FAILED 💥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pipeline Status:** ❌ **FAILURE**" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ job.status }}" == "cancelled" ]; then
          echo "### 🛑 PIPELINE CANCELLED 🛑" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pipeline Status:** ⚠️ **CANCELLED**" >> $GITHUB_STEP_SUMMARY
        else
          echo "**Pipeline Status:** ⚠️ **UNKNOWN**" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: 🎯 Display Final Status
      if: always()
      run: |
        echo ""
        echo "┌─────────────────────────────────────────────────────────────┐"
        echo "│                    CI PIPELINE COMPLETE                     │"
        echo "├─────────────────────────────────────────────────────────────┤"
        echo "│ Python Version: 3.12.5                                      │"
        echo "├─────────────────────────────────────────────────────────────┤"

        get_icon() {
          case "$1" in
            "success") echo "✅" ;;
            "failure") echo "❌" ;;
            "skipped") echo "⏭️" ;;
            *) echo "⚠️" ;;
          esac
        }
        TESTS_ICON=$(get_icon "${{ steps.run_tests.outcome }}")
        echo "│ $TESTS_ICON Tests Execution   - All test suites                      │"
        echo "├─────────────────────────────────────────────────────────────┤"
        if [ "${{ job.status }}" == "success" ]; then
          echo "│                    ✨ ALL CHECKS PASSED ✨                 │"
          echo "│                   ✅  PIPELINE: SUCCESS  ✅                │"
        elif [ "${{ job.status }}" == "failure" ]; then
          echo "│                   💥 SOME CHECKS FAILED 💥                 │"
          echo "│                   ❌  PIPELINE: FAILURE  ❌                │"
        elif [ "${{ job.status }}" == "cancelled" ]; then
          echo "│                    🛑 PIPELINE CANCELLED 🛑                │"
          echo "│                   ⚠️   STATUS: CANCELLED   ⚠️              │"
        else
          echo "│                    ⚠️  UNKNOWN STATUS  ⚠️                  │"
        fi
        
        echo "└─────────────────────────────────────────────────────────────┘"
        echo ""
        echo "📋 Detailed report available in GitHub Actions summary"
