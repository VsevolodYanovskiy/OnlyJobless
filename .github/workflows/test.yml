name: CI Tests - Changed Files Only

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]

jobs:
  test-changed:
    name: Test Changed Files
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: üì• Checkout code with full history
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    
    - name: üêç Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'
        cache-dependency-path: 'docs/requirements.txt'
    
    - name: üì¶ Install dependencies
      run: |
        python -m pip install --upgrade pip
        # –û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞
        pip install fastapi uvicorn sqlalchemy pydantic pytest pytest-cov
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –µ—Å–ª–∏ –µ—Å—Ç—å requirements.txt
        if [ -f docs/requirements.txt ]; then
          pip install -r docs/requirements.txt 2>/dev/null || true
        fi
    
    - name: üîç Get changed Python files
      id: changed_files
      run: |
        echo "Event type: ${{ github.event_name }}"
        
        # –î–ª—è PR: —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å –±–∞–∑–æ–≤–æ–π –≤–µ—Ç–∫–æ–π
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          BASE_REF="${{ github.base_ref }}"
          echo "PR: Comparing with base ref: $BASE_REF"
          # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö .py —Ñ–∞–π–ª–æ–≤
          git diff --name-only "origin/$BASE_REF"...HEAD -- '*.py' > changed_py_files.txt
          
        # –î–ª—è –ø—É—à–∞: —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º –∫–æ–º–º–∏—Ç–æ–º  
        else
          echo "Push: Comparing with previous commit"
          git diff --name-only HEAD~1 HEAD -- '*.py' > changed_py_files.txt
        fi
        
        # –ü–æ–∫–∞–∑–∞—Ç—å —á—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
        echo "Changed Python files:"
        cat changed_py_files.txt 2>/dev/null || echo "No changes"
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ output
        CHANGED_CONTENT=$(cat changed_py_files.txt 2>/dev/null || echo "")
        echo "changed_py_files<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGED_CONTENT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: üß™ Run tests for changed modules
      id: run_tests
      env:
        SECRET_KEY: test-secret-123
        ALGORITHM: HS256
        ENVIRONMENT: test
      run: |
        # –ï—Å–ª–∏ –Ω–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö .py —Ñ–∞–π–ª–æ–≤ - –≤—ã—Ö–æ–¥ —Å —É—Å–ø–µ—Ö–æ–º
        if [ -z "${{ steps.changed_files.outputs.changed_py_files }}" ]; then
          echo "‚úÖ No Python files changed - SUCCESS"
          exit 0
        fi
        
        echo "=== Changed Python files ==="
        echo "${{ steps.changed_files.outputs.changed_py_files }}"
        echo "============================"
        
        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å–æ —Å–ø–∏—Å–∫–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–π
        echo "${{ steps.changed_files.outputs.changed_py_files }}" > /tmp/changed_files.txt
        
        # Python —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ –∑–∞–ø—É—Å–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ç–µ—Å—Ç–æ–≤
        python3 -c "
import os
import subprocess
import sys

# –ß–∏—Ç–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
with open('/tmp/changed_files.txt', 'r') as f:
    changed_files = [line.strip() for line in f if line.strip()]

print(f'Found {len(changed_files)} changed Python file(s)')

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∏—Å—Ö–æ–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ —Å —Ç–µ—Å—Ç–∞–º–∏
test_map = {}

for changed_file in changed_files:
    # –ü–æ–ª—É—á–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
    # –ü—Ä–∏–º–µ—Ä: src/back/auth/controllers/auth.py -> auth
    filename = os.path.basename(changed_file).replace('.py', '')
    dirname = os.path.dirname(changed_file)
    
    print(f'\\nProcessing: {changed_file}')
    print(f'  Filename: {filename}')
    print(f'  Directory: {dirname}')
    
    # –í–∞—Ä–∏–∞–Ω—Ç 1: –ò—â–µ–º test_<filename>.py –≤ tests/
    possible_tests = [
        f'tests/test_{filename}.py',
        f'tests/{filename}/test_{filename}.py',
        f'tests/{filename}_test.py',
    ]
    
    # –í–∞—Ä–∏–∞–Ω—Ç 2: –ò—â–µ–º –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –∫–∞—Ç–∞–ª–æ–≥–æ–≤
    # src/back/auth/controllers/auth.py -> tests/auth/controllers/test_auth.py
    if 'src/' in changed_file:
        rel_path = changed_file.split('src/')[-1]
        test_path = 'tests/' + rel_path.replace('.py', '').replace('/', '/test_') + '.py'
        possible_tests.append(test_path)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π –≤–æ–∑–º–æ–∂–Ω—ã–π —Ç–µ—Å—Ç
    found_tests = []
    for test_file in possible_tests:
        if os.path.exists(test_file):
            found_tests.append(test_file)
            print(f'  Found test: {test_file}')
    
    if found_tests:
        test_map[changed_file] = found_tests
    else:
        print(f'  ‚ö†Ô∏è No specific test found for {filename}')
        
        # –ò—â–µ–º –ª—é–±—ã–µ —Ç–µ—Å—Ç—ã, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ –∏–º—è —Ñ–∞–π–ª–∞
        import glob
        all_tests = glob.glob('tests/**/*.py', recursive=True)
        matching_tests = [t for t in all_tests if filename in t and 'test' in t]
        
        if matching_tests:
            print(f'  Found related tests: {matching_tests}')
            test_map[changed_file] = matching_tests

# –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã
all_test_files = set()
for tests in test_map.values():
    all_test_files.update(tests)

print(f'\\n=== Summary ===')
print(f'Changed files: {len(changed_files)}')
print(f'Test files to run: {len(all_test_files)}')

if all_test_files:
    print(f'\\nRunning tests:')
    for test_file in sorted(all_test_files):
        print(f'  - {test_file}')
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã
    cmd = ['pytest', '-v', '--tb=short'] + list(all_test_files)
    print(f'\\nCommand: {\" \".join(cmd)}')
    result = subprocess.run(cmd)
    sys.exit(result.returncode)
else:
    print('\\n‚ö†Ô∏è No specific tests found for changed files')
    print('Running all tests instead...')
    result = subprocess.run(['pytest', 'tests/', '-v', '--tb=short'])
    sys.exit(result.returncode)
"
    
    - name: üìä –ï—Å–ª–∏ –Ω–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏–π - –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ
      if: steps.run_tests.outcome == 'failure'
      env:
        SECRET_KEY: test-secret-123
        ALGORITHM: HS256
        ENVIRONMENT: test
      run: |
        echo "Running all tests after specific tests failed..."
        python -m pytest tests/ -v --tb=short
    
    - name: ‚úÖ Final success check
      if: always()
      run: |
        echo "========================================"
        echo "üéØ CI Pipeline completed"
        echo "‚úÖ Checked only changed files"
        echo "========================================"
