name: CI Tests

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]

jobs:
  test:
    name: Run Tests & Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ Setup Python 3.12.5
      uses: actions/setup-python@v4
      with:
        python-version: '3.12.5'
        cache: 'pip'
    
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        # ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¾Ð²
        pip install bcrypt pytest pytest-cov
        
        # Ð”Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð° ÐºÐ¾Ð´Ð°
        pip install flake8 mypy
        
        # ÐžÐ¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾ - requirements.txt
        if [ -f docs/requirements.txt ]; then
          pip install -r docs/requirements.txt 2>/dev/null || true
        fi
    
    - name: ðŸ” Check project structure
      run: |
        echo "=== Project structure ==="
        find . -name "*.py" | head -20
        echo "=== Tests ==="
        ls -la tests/ 2>/dev/null || echo "No tests directory"
        echo "=== src ==="
        ls -la src/ 2>/dev/null || echo "No src directory"
    
    - name: ðŸ§¹ Run flake8 linting
      run: |
        echo "=== Running flake8 ==="
        if [ -d "src" ]; then
          flake8 src/ --count --max-line-length=120 --statistics --show-source
        else
          echo "No src directory to lint"
        fi
        
        if [ -d "tests" ]; then
          flake8 tests/ --count --max-line-length=120 --statistics --show-source
        else
          echo "No tests directory to lint"
        fi
    
    - name: ðŸ“ Run mypy type checking
      run: |
        echo "=== Running mypy ==="
        if [ -d "src" ]; then
          mypy src/ --ignore-missing-imports --show-error-codes
        else
          echo "No src directory for type checking"
        fi
        
        if [ -d "tests" ]; then
          mypy tests/ --ignore-missing-imports --show-error-codes
        else
          echo "No tests directory for type checking"
        fi
    
    - name: ðŸ§ª Run tests if they exist
      run: |
        # Ð•ÑÐ»Ð¸ Ð½ÐµÑ‚ Ñ‚ÐµÑÑ‚Ð¾Ð² - ÑƒÑÐ¿ÐµÑ…
        if [ ! -d "tests" ]; then
          echo "âœ… No tests directory - SUCCESS"
          exit 0
        fi
        
        # Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ñ„Ð°Ð¹Ð»Ñ‹ test_*.py - Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼
        if find tests -name "test_*.py" -type f | grep -q .; then
          echo "=== Running pytest ==="
          python -m pytest tests/ -v --tb=short --cov=src --cov-report=term-missing
        else
          echo "âœ… No test files found - SUCCESS"
        fi
    
    - name: ðŸ“Š Generate coverage report
      if: always()
      run: |
        echo "=== Coverage Summary ==="
        if [ -d "tests" ] && [ -d "src" ]; then
          python -m pytest tests/ --cov=src --cov-report=xml --quiet 2>/dev/null || true
          if [ -f "coverage.xml" ]; then
            echo "Coverage report generated"
          fi
        fi
    
    - name: âœ… Final status
      if: always()
      run: |
        echo "========================================"
        echo "ðŸŽ¯ CI Pipeline Summary"
        echo "âœ… Python 3.12.5"
        echo "âœ… Tests checked"
        echo "âœ… Code quality (flake8, mypy)"
        echo "========================================"
