name: CI Tests

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]

jobs:
  test:
    name: Run Tests & Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: ๐ฅ Checkout code
      id: checkout
      uses: actions/checkout@v4
    
    - name: ๐ Setup Python 3.12.5
      id: setup_python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12.5'
        cache: 'pip'
    
    - name: ๐ฆ Install dependencies
      id: install_deps
      run: |
        python -m pip install --upgrade pip

        if [ -f docs/requirements.txt ]; then
          echo "Installing dependencies from docs/requirements.txt..."
          pip install -r docs/requirements.txt
        else
          echo "ERROR: docs/requirements.txt not found!"
          pip install bcrypt pytest pytest-cov flake8 mypy
          exit 1
        fi
    
    - name: ๐ Check project structure
      id: check_structure
      run: |
        echo "=== Project structure ==="
        find . -name "*.py" | head -5
        echo "Tests dir exists:" && [ -d "tests" ] && echo "YES" || echo "NO"
        echo "Src dir exists:" && [ -d "src" ] && echo "YES" || echo "NO"
    
    - name: ๐งน Run flake8
      id: flake8_lint
      run: |
        echo "=== Flake8 checking ==="
        if [ -d "src" ]; then
          echo "Excluding src/front directory from flake8 checks"
          
          find src -name "*.py" -not -path "*/front/*" | while read -r file; do
            echo "Checking: $file"
            flake8 "$file" \
              --config=.flake8 \
              --show-source \
              --statistics \
              --count
          done
        else
          echo "No src directory - skipping flake8"
          exit 0
        fi

    - name: ๐ Run mypy
      id: mypy_check
      run: |
        echo "=== Mypy check ==="
        
        if [ -d "src" ]; then
          echo "Excluding src/front directory from mypy checks"
          
          TEMP_FILE=$(mktemp)
          
          python -m mypy src/ \
            --python-version 3.12 \
            --ignore-missing-imports \
            --show-error-codes \
            --no-error-summary \
            --exclude "front/" 2>&1 > "$TEMP_FILE" || true
          
          sed -i '/Source file found twice/,/adjusting MYPYPATH/d' "$TEMP_FILE"
          
          if grep -q "error:" "$TEMP_FILE"; then
            echo "โ Mypy found real errors:"
            cat "$TEMP_FILE"
            rm "$TEMP_FILE"
            exit 1
          else
            echo "โ Mypy passed"
            rm "$TEMP_FILE"
          fi
        else
          echo "No src directory"
          exit 0
        fi
    
    - name: ๐งช Run tests
      id: run_tests
      env:
        ENCRYPTION_KEY: "dGVzdF9rZXlfMzJfY2hhcnNfZm9yX2Flc18yNTY="
        SECRET_KEY: "test_secret_key_for_ci_1234567890"
        DATABASE_URL: "sqlite:///./test.db"
        ENVIRONMENT: "test"
        JWT_ALGORITHM: "HS256"
        JWT_ACCESS_TOKEN_EXPIRE_MINUTES: "30"
      run: |
        echo "=== Test Execution ==="
        
        if [ ! -d "tests" ]; then
          echo "โ No tests directory - SUCCESS"
          exit 0
        fi
        
        TEST_COUNT=$(find tests -name "test_*.py" -type f | wc -l)
        echo "Found $TEST_COUNT test file(s)"
        
        if [ $TEST_COUNT -gt 0 ]; then
          echo "Running tests..."
          
          if [ -d "src" ]; then
            python -m pytest tests/ -v --tb=short --cov=src --cov-report=term-missing --junitxml=test-results.xml
            TEST_EXIT_CODE=$?
          else
            python -m pytest tests/ -v --tb=short --junitxml=test-results.xml
            TEST_EXIT_CODE=$?
          fi
          
          if [ $TEST_EXIT_CODE -eq 0 ]; then
            echo "โ All tests passed"
          else
            echo "โ Some tests failed"
            exit $TEST_EXIT_CODE
          fi
        else
          echo "โ No test files found - SUCCESS"
        fi
    
    - name: ๐ Upload test results
      if: always() && steps.run_tests.outcome == 'success' || steps.run_tests.outcome == 'failure'
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: test-results.xml
    
    - name: ๐ Generate CI Report
      if: always()
      id: generate_report
      run: |
        format_status() {
          case "$1" in
            "success")
              echo "โ PASSED"
              ;;
            "failure")
              echo "โ FAILED"
              ;;
            "skipped")
              echo "โญ๏ธ SKIPPED"
              ;;
            "cancelled")
              echo "๐ CANCELLED"
              ;;
            *)
              echo "โ๏ธ $1"
              ;;
          esac
        }

        FLAKE8_STATUS=$(format_status "${{ steps.flake8_lint.outcome }}")
        MYPY_STATUS=$(format_status "${{ steps.mypy_check.outcome }}")
        TESTS_STATUS=$(format_status "${{ steps.run_tests.outcome }}")

        echo "## ๐ CI Pipeline Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Python Version:** 3.12.5" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ๐ Quality Checks" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status | Details |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|---------|" >> $GITHUB_STEP_SUMMARY
        echo "| **Flake8 Linting** | $FLAKE8_STATUS | Code style checking (excl. src/front) |" >> $GITHUB_STEP_SUMMARY
        echo "| **Mypy Type Check** | $MYPY_STATUS | Static type checking (excl. src/front) |" >> $GITHUB_STEP_SUMMARY
        echo "| **Tests Execution** | $TESTS_STATUS | Unit and integration tests |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ๐ฏ Final Result" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ job.status }}" == "success" ]; then
          echo "### โจ ALL CHECKS PASSED โจ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pipeline Status:** โ **SUCCESS**" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ job.status }}" == "failure" ]; then
          echo "### ๐ฅ SOME CHECKS FAILED ๐ฅ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pipeline Status:** โ **FAILURE**" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ job.status }}" == "cancelled" ]; then
          echo "### ๐ PIPELINE CANCELLED ๐" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pipeline Status:** โ๏ธ **CANCELLED**" >> $GITHUB_STEP_SUMMARY
        else
          echo "**Pipeline Status:** โ๏ธ **UNKNOWN**" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: ๐ฏ Display Final Status
      if: always()
      run: |
        echo ""
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
        echo "โ                    CI PIPELINE COMPLETE                     โ"
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค"
        echo "โ Python Version: 3.12.5                                      โ"
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค"

        get_icon() {
          case "$1" in
            "success") echo "โ" ;;
            "failure") echo "โ" ;;
            "skipped") echo "โญ๏ธ" ;;
            *) echo "โ๏ธ" ;;
          esac
        }
        
        FLAKE8_ICON=$(get_icon "${{ steps.flake8_lint.outcome }}")
        MYPY_ICON=$(get_icon "${{ steps.mypy_check.outcome }}")
        TESTS_ICON=$(get_icon "${{ steps.run_tests.outcome }}")
        
        echo "โ $FLAKE8_ICON Flake8 Linting   - Code style (excl. front)     โ"
        echo "โ $MYPY_ICON Mypy Type Check    - Static typing (excl. front)  โ"
        echo "โ $TESTS_ICON Tests Execution   - All test suites              โ"
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค"
        if [ "${{ job.status }}" == "success" ]; then
          echo "โ                    โจ ALL CHECKS PASSED โจ                   โ"
          echo "โ                   โ  PIPELINE: SUCCESS  โ                  โ"
        elif [ "${{ job.status }}" == "failure" ]; then
          echo "โ                   ๐ฅ SOME CHECKS FAILED ๐ฅ                   โ"
          echo "โ                   โ  PIPELINE: FAILURE  โ                  โ"
        elif [ "${{ job.status }}" == "cancelled" ]; then
          echo "โ                    ๐ PIPELINE CANCELLED ๐                  โ"
          echo "โ                   โ๏ธ   STATUS: CANCELLED   โ๏ธ                โ"
        else
          echo "โ                    โ๏ธ  UNKNOWN STATUS  โ๏ธ                    โ"
        fi
        
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
        echo ""
        echo "๐ Detailed report available in GitHub Actions summary"
